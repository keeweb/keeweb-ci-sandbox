name: Build
on:
  push:
    branches: [ master ]
#    tags: [ '*' ]
jobs:
  web:
    runs-on: ubuntu-latest
    steps:
      - name: Write keys
        env:
          XX: ${{ secrets.XX }}
        run: |
          mkdir keys
          echo "$XX" > keys/xx
          echo "Contents"
          cat keys/xx
          echo "End"
          break-here
      - name: Get current git ref
        id: git_ref
        #run: echo ::set-output name=ref::${GITHUB_REF/refs\/tags\//}
        run: echo ::set-output name=ref::1.13.0
      - uses: actions/checkout@v2
        with:
          repository: 'keeweb/keeweb'
          ref: 'develop'
      - name: Install npm modules
        run: npm ci
      - name: Test
        run: npm test
      - name: Grunt
        run: grunt
      - name: Grunt desktop
        run: grunt gitinfo build-desktop-app-content build-desktop-update
      - name: Upload artifact
        uses: actions/upload-artifact@v1
        with:
          name: KeeWeb-${{ steps.git_ref.outputs.ref }}.html.zip
          path: dist
  linux:
    runs-on: ubuntu-latest
    needs:
      - web
    steps:
      - name: Get current git ref
        id: git_ref
        #run: echo ::set-output name=ref::${GITHUB_REF/refs\/tags\//}
        run: echo ::set-output name=ref::1.13.0
      - uses: actions/checkout@v2
        with:
          repository: 'keeweb/keeweb'
          ref: 'develop'
      - name: Download atrifact
        uses: actions/download-artifact@v1
        with:
          name: KeeWeb-${{ steps.git_ref.outputs.ref }}.html.zip
          path: dist
      - uses: ./.github/actions/linux-build
      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v1
        with:
          name: KeeWeb-${{ steps.git_ref.outputs.ref }}.linux.AppImage
          path: dist/desktop/KeeWeb-${{ steps.git_ref.outputs.ref }}.linux.AppImage
      - name: Upload snap artifact
        uses: actions/upload-artifact@v1
        with:
          name: KeeWeb-${{ steps.git_ref.outputs.ref }}.linux.snap
          path: dist/desktop/KeeWeb-${{ steps.git_ref.outputs.ref }}.linux.snap
      - name: Upload deb artifact
        uses: actions/upload-artifact@v1
        with:
          name: KeeWeb-${{ steps.git_ref.outputs.ref }}.linux.x64.deb
          path: dist/desktop/KeeWeb-${{ steps.git_ref.outputs.ref }}.linux.x64.deb
      - name: Upload zip artifact
        uses: actions/upload-artifact@v1
        with:
          name: KeeWeb-${{ steps.git_ref.outputs.ref }}.linux.x64.zip
          path: dist/desktop/KeeWeb-${{ steps.git_ref.outputs.ref }}.linux.x64.zip
      - name: Upload rpm artifact
        uses: actions/upload-artifact@v1
        with:
          name: KeeWeb-${{ steps.git_ref.outputs.ref }}.linux.x86_64.rpm
          path: dist/desktop/KeeWeb-${{ steps.git_ref.outputs.ref }}.linux.x86_64.rpm
